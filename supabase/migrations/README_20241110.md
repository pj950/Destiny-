# Migration 20241110000001: Database Schema Extension

## Overview

This migration extends the Eastern Destiny database schema to support:

1. **AI-Generated Reports** - Store comprehensive BaZi character profiles and yearly flow predictions
2. **Vector Embeddings** - Enable RAG (Retrieval-Augmented Generation) for intelligent Q&A
3. **Conversation Management** - Track multi-turn Q&A sessions with message history
4. **Usage Tracking** - Enforce question limits based on subscription tier
5. **Subscription Management** - Integrate Razorpay subscriptions with tiered access

## Quick Stats

- **File**: `20241110000001_extend_schema_reports_subscriptions.sql`
- **Lines**: 410
- **Tables Created**: 5
- **Columns Added**: 3 (to existing `charts` table)
- **Indexes Created**: 23
- **RLS Policies**: 16
- **Triggers**: 4

## What's Included

### 1. Vector Extension
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```
Enables pgvector for 768-dimensional embeddings (Gemini text-embedding-004).

### 2. Extended Charts Table
```sql
ALTER TABLE charts ADD COLUMN day_master TEXT;
ALTER TABLE charts ADD COLUMN ten_gods JSONB;
ALTER TABLE charts ADD COLUMN luck_cycles JSONB;
```
Adds BaZi analysis fields for Day Master, Ten Gods, and Luck Cycles.

### 3. New Tables

#### bazi_reports
Stores AI-generated reports with structured content.

**Key Fields**:
- `report_type`: 'character_profile' | 'yearly_flow'
- `structured`: JSONB for programmatic access
- `body`: Full markdown/text content
- `status`: 'pending' | 'processing' | 'completed' | 'failed'

#### bazi_report_chunks
Chunked content with vector embeddings for semantic search.

**Key Fields**:
- `content`: Text chunk (500-1000 chars)
- `embedding`: vector(768) for similarity search
- `metadata`: JSONB with section info, keywords, importance

#### qa_conversations
Multi-turn Q&A sessions linked to reports.

**Key Fields**:
- `messages`: JSONB array of user/assistant messages
- `subscription_tier`: For usage limit enforcement
- `retention_until`: Auto-deletion based on tier

#### qa_usage_tracking
Tracks question usage per user and period.

**Key Fields**:
- `period_start/end`: Billing period
- `questions_used`: Counter for current period
- `extra_questions`: One-time purchases

#### user_subscriptions
Razorpay-integrated subscription management.

**Key Fields**:
- `tier`: 'free' | 'basic' | 'premium' | 'vip'
- `status`: 'active' | 'past_due' | 'canceled' | 'expired'
- `external_subscription_id`: Razorpay subscription ID

### 4. Indexes

**Performance Optimizations**:
- B-tree indexes for filtering (user_id, report_id, status, etc.)
- GIN indexes for JSONB queries (ten_gods, luck_cycles, metadata)
- **HNSW vector index** for fast similarity search (~5-10ms on 10k vectors)
- Unique indexes for data integrity (one active subscription per user)

### 5. RLS Policies

**Security Model**:
- Users can view/manage their own data
- Anonymous access allowed for MVP mode
- Service role bypasses all RLS for server-side operations
- Critical tables (usage tracking) only writable by service role

### 6. Triggers

Auto-update `updated_at` timestamps on:
- `bazi_reports`
- `qa_conversations`
- `qa_usage_tracking`
- `user_subscriptions`

## Usage Limits by Tier

| Tier | Questions/Month | Price | Reports/Month |
|------|-----------------|-------|---------------|
| Free | 3 | ¥0 | 1 |
| Basic | 10 | ¥29/month | 3 |
| Premium | 50 | ¥99/month | 10 |
| VIP | Unlimited | ¥299/month | Unlimited |

## Running the Migration

### Option 1: Supabase Dashboard (Recommended)
1. Open your Supabase project
2. Go to **SQL Editor**
3. Create new query
4. Copy and paste entire migration file
5. Click **Run**
6. Verify success

### Option 2: Supabase CLI
```bash
supabase link --project-ref <your-project-ref>
supabase db push
```

## Verification

After running, verify with:

```sql
-- Check vector extension
SELECT * FROM pg_extension WHERE extname = 'vector';

-- Count new tables (should be 5)
SELECT COUNT(*) FROM pg_tables 
WHERE tablename IN ('bazi_reports', 'bazi_report_chunks', 'qa_conversations', 'qa_usage_tracking', 'user_subscriptions');

-- Count indexes (should be 23+)
SELECT COUNT(*) FROM pg_indexes 
WHERE tablename IN ('charts', 'bazi_reports', 'bazi_report_chunks', 'qa_conversations', 'qa_usage_tracking', 'user_subscriptions');

-- Count RLS policies (should be 16+)
SELECT COUNT(*) FROM pg_policies 
WHERE tablename IN ('bazi_reports', 'bazi_report_chunks', 'qa_conversations', 'qa_usage_tracking', 'user_subscriptions');
```

## Documentation

- **Complete Guide**: `/docs/BAZI_REPORTS_AND_SUBSCRIPTIONS.md`
- **Quick Reference**: `/docs/MIGRATION_20241110_SUMMARY.md`
- **Deployment Guide**: `/DEPLOYMENT_GUIDE_MIGRATION.md`
- **Checklist**: `/MIGRATION_CHECKLIST.md`
- **TypeScript Types**: `/types/database.ts`

## Rollback

If issues occur:

```sql
DROP TABLE IF EXISTS user_subscriptions CASCADE;
DROP TABLE IF EXISTS qa_usage_tracking CASCADE;
DROP TABLE IF EXISTS qa_conversations CASCADE;
DROP TABLE IF EXISTS bazi_report_chunks CASCADE;
DROP TABLE IF EXISTS bazi_reports CASCADE;

ALTER TABLE charts DROP COLUMN IF EXISTS day_master;
ALTER TABLE charts DROP COLUMN IF EXISTS ten_gods;
ALTER TABLE charts DROP COLUMN IF EXISTS luck_cycles;

DROP FUNCTION IF EXISTS update_updated_at_column();
```

Then restore from backup.

## Environment Variables

Add these after migration:

```bash
GEMINI_MODEL_EMBEDDING=text-embedding-004
RAZORPAY_PLAN_BASIC=plan_basic_xxx
RAZORPAY_PLAN_PREMIUM=plan_premium_xxx
RAZORPAY_PLAN_VIP=plan_vip_xxx
```

## Notes

- **Safe to Re-run**: Uses `IF NOT EXISTS` clauses throughout
- **Backward Compatible**: Existing tables and data not affected
- **Performance**: HNSW index provides ~10x faster vector search than IVFFlat
- **Embedding Model**: Designed for Gemini text-embedding-004 (768d)
- **Data Retention**: Conversations auto-deleted based on subscription tier

---

**Created**: 2024-11-10  
**Status**: ✅ Production Ready  
**Version**: 20241110000001
